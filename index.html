<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>E-MESG Minimal Auth + Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
    input, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
    button { cursor: pointer; background: black; color: white; border: none; border-radius: 4px; }
    #messages { border: 1px solid #ddd; height: 300px; overflow-y: auto; padding: 10px; margin-top: 10px; background: #fff; }
    .message { margin-bottom: 10px; }
    .message.you { text-align: right; }
    .message .text { display: inline-block; padding: 8px 12px; border-radius: 15px; background: #007bff; color: white; max-width: 70%; }
    .message.you .text { background: #28a745; }
    #status-msg { font-weight: bold; margin-top: 10px; color: green; }
    #logout-btn { background: #dc3545; margin-top: 10px; }
    #friend-email { width: 70%; display: inline-block; }
    #send-btn { width: auto; display: inline-block; margin-left: 5px; }
    #new-message { width: 80%; display: inline-block; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Auth Section -->
    <div id="auth-section">
      <h2>üîê Login / Signup</h2>
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <button id="signup-btn">Sign Up</button>
      <button id="login-btn">Log In</button>
      <p id="auth-msg"></p>
    </div>

    <!-- Chat Section -->
    <div id="chat-section" style="display:none;">
      <div>
        Logged in as: <span id="user-email"></span>
        <button id="logout-btn">Logout</button>
      </div>

      <input type="email" id="friend-email" placeholder="Friend's email" />
      <button id="start-chat-btn">Start Chat</button>

      <div id="messages"></div>

      <input type="text" id="new-message" placeholder="Type message..." disabled />
      <button id="send-btn" disabled>Send</button>

      <p id="chat-status-msg"></p>
    </div>
  </div>

<script>
  const SUPABASE_URL = "https://noqmpozmglkiprkakeab.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vcW1wb3ptZ2xraXBya2FrZWFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5ODExNzksImV4cCI6MjA3MDU1NzE3OX0.rrwRu_BKxXQJE-X49ItQE5s8Q_vNaUiZz1-0wO_tEAY";

  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentUser = null;
  let chatFriend = null;
  let messagesSubscription = null;

  // Elements
  const authSection = document.getElementById('auth-section');
  const chatSection = document.getElementById('chat-section');
  const authMsg = document.getElementById('auth-msg');
  const chatStatusMsg = document.getElementById('chat-status-msg');

  // Show message helper
  function showAuthMessage(msg, isError = false) {
    authMsg.style.color = isError ? 'red' : 'green';
    authMsg.innerText = msg;
  }
  function showChatStatus(msg, isError = false) {
    chatStatusMsg.style.color = isError ? 'red' : 'green';
    chatStatusMsg.innerText = msg;
  }

  // Signup
  document.getElementById('signup-btn').onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password) {
      showAuthMessage("Please enter email and password", true);
      return;
    }
    const { data, error } = await supabase.auth.signUp({ email, password });
    if (error) {
      showAuthMessage("Signup error: " + error.message, true);
    } else {
      showAuthMessage("‚úÖ Signup successful! Check your email for confirmation.");
    }
  };

  // Login
  document.getElementById('login-btn').onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password) {
      showAuthMessage("Please enter email and password", true);
      return;
    }
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      showAuthMessage("Login error: " + error.message, true);
    } else {
      showAuthMessage("‚úÖ Logged in successfully!");
      currentUser = data.user;
      openChat();
    }
  };

  // Open chat UI
  async function openChat() {
    authSection.style.display = 'none';
    chatSection.style.display = 'block';
    document.getElementById('user-email').innerText = currentUser.email;
  }

  // Logout
  document.getElementById('logout-btn').onclick = async () => {
    await supabase.auth.signOut();
    currentUser = null;
    chatFriend = null;
    authSection.style.display = 'block';
    chatSection.style.display = 'none';
    showAuthMessage('');
    clearChat();
  };

  // Start chat with friend
  document.getElementById('start-chat-btn').onclick = async () => {
    const friendEmail = document.getElementById('friend-email').value.trim().toLowerCase();
    if (!friendEmail) {
      alert("Please enter your friend's email");
      return;
    }
    if (friendEmail === currentUser.email) {
      alert("You cannot chat with yourself!");
      return;
    }
    const { data, error } = await supabase
      .from('users')
      .select('id,email')
      .eq('email', friendEmail)
      .single();

    if (error || !data) {
      alert("User not found");
      return;
    }
    chatFriend = data;
    enableChat();
    loadMessages();
    subscribeToMessages();
  };

  function enableChat() {
    document.getElementById('new-message').disabled = false;
    document.getElementById('send-btn').disabled = false;
    document.getElementById('messages').innerHTML = '';
    showChatStatus('');
  }

  function clearChat() {
    document.getElementById('friend-email').value = '';
    document.getElementById('new-message').value = '';
    document.getElementById('new-message').disabled = true;
    document.getElementById('send-btn').disabled = true;
    document.getElementById('messages').innerHTML = '';
    showChatStatus('');
  }

  // Load chat messages
  async function loadMessages() {
    if (!chatFriend) return;
    const { data, error } = await supabase
      .from('messages')
      .select('*')
      .or(
        `and(sender_id.eq.${currentUser.id},receiver_id.eq.${chatFriend.id}),and(sender_id.eq.${chatFriend.id},receiver_id.eq.${currentUser.id})`
      )
      .order('created_at', { ascending: true });

    if (error) {
      showChatStatus("Error loading messages: " + error.message, true);
      return;
    }
    const messagesDiv = document.getElementById('messages');
    messagesDiv.innerHTML = '';
    data.forEach(addMessageToDOM);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // Subscribe to new messages in realtime
  function subscribeToMessages() {
    if (messagesSubscription) {
      messagesSubscription.unsubscribe();
    }
    messagesSubscription = supabase
      .channel('public:messages')
      .on(
        'postgres_changes',
        { event: 'INSERT', schema: 'public', table: 'messages' },
        payload => {
          const msg = payload.new;
          if (
            (msg.sender_id === currentUser.id && msg.receiver_id === chatFriend.id) ||
            (msg.sender_id === chatFriend.id && msg.receiver_id === currentUser.id)
          ) {
            addMessageToDOM(msg);
          }
        }
      )
      .subscribe();
  }

  // Add message to chat DOM
  function addMessageToDOM(msg) {
    const messagesDiv = document.getElementById('messages');
    const div = document.createElement('div');
    div.classList.add('message');
    if (msg.sender_id === currentUser.id) div.classList.add('you');

    const textDiv = document.createElement('div');
    textDiv.classList.add('text');
    textDiv.textContent = msg.content;

    div.appendChild(textDiv);
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // Send new message
  document.getElementById('send-btn').onclick = async () => {
    const content = document.getElementById('new-message').value.trim();
    if (!content) return;

    const { error } = await supabase.from('messages').insert([{
      sender_id: currentUser.id,
      receiver_id: chatFriend.id,
      content,
    }]);

    if (error) {
      showChatStatus("Error sending message: " + error.message, true);
    } else {
      document.getElementById('new-message').value = '';
    }
  };

  // Check if user already logged in on page load
  window.onload = async () => {
    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
      currentUser = user;
      openChat();
    }
  };
</script>
</body>
</html>

