<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>E-MESG Minimal Auth + Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial; padding: 20px; background:#f9f9f9;}
    .container { max-width:600px; margin:auto; background:white; padding:20px; border-radius:8px;}
    input, button { padding:10px; margin:5px 0; width:100%; box-sizing:border-box;}
    button { cursor:pointer; background:black; color:white; border:none; border-radius:4px;}
    #messages { border:1px solid #ddd; height:300px; overflow-y:auto; padding:10px; margin-top:10px;}
    .message { margin-bottom:10px; }
    .message.you { text-align:right; }
    .message .text { display:inline-block; padding:8px 12px; border-radius:15px; background:#007bff; color:white; max-width:70%; }
    .message.you .text { background:#28a745; }
  </style>
</head>
<body>
<div class="container">
  <div id="auth-section">
    <h2>Login / Signup</h2>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button id="auth-btn">Sign Up / Login</button>
    <p id="auth-msg"></p>
  </div>

  <div id="chat-section" style="display:none;">
    <p>Logged in as: <span id="user-email"></span> <button id="logout-btn">Logout</button></p>
    <input type="email" id="friend-email" placeholder="Friend's email"/>
    <button id="start-chat-btn">Start Chat</button>
    <div id="messages"></div>
    <input type="text" id="new-message" placeholder="Type message..." disabled />
    <button id="send-btn" disabled>Send</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://noqmpozmglkiprkakeab.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vcW1wb3ptZ2xraXBya2FrZWFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5ODExNzksImV4cCI6MjA3MDU1NzE3OX0.rrwRu_BKxXQJE-X49ItQE5s8Q_vNaUiZz1-0wO_tEAY";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let chatFriend = null;
let messagesSubscription = null;

const authSection = document.getElementById('auth-section');
const chatSection = document.getElementById('chat-section');
const authMsg = document.getElementById('auth-msg');

function showAuthMessage(msg, isError=false){
  authMsg.style.color = isError?'red':'green';
  authMsg.innerText = msg;
}

document.getElementById('auth-btn').onclick = async () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  if(!email || !password) return showAuthMessage("Enter email & password", true);

  // Try signup
  let { data:signupData, error:signupError } = await supabase.auth.signUp({email, password});
  
  if(signupError && signupError.message.includes("User already registered")){
    // If already exists, login
    let { data:loginData, error:loginError } = await supabase.auth.signInWithPassword({email, password});
    if(loginError) return showAuthMessage("Login error: "+loginError.message, true);
    currentUser = loginData.user;
    showAuthMessage("✅ Logged in!");
  } else if(signupError){
    return showAuthMessage("Signup error: "+signupError.message, true);
  } else {
    currentUser = signupData.user;
    showAuthMessage("✅ Signed up & logged in!");
  }

  document.getElementById('email').value='';
  document.getElementById('password').value='';
  document.getElementById('user-email').innerText = currentUser.email;
  authSection.style.display='none';
  chatSection.style.display='block';
};
</script>
</body>
</html>
